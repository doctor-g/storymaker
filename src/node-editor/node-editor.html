<link rel="import"
      href="../../bower_components/polymer/polymer-element.html">
<link rel="import"
      href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import"
      href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import"
      href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import"
      href="../../bower_components/paper-button/paper-button.html">
<link rel="import"
      href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import"
      href="../../bower_components/paper-input/paper-input.html">
<link rel="import"
      href="../../bower_components/paper-item/paper-item.html">
<link rel="import"
      href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import"
      href="../../bower_components/paper-input/paper-textarea.html">

<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">


<dom-module id="node-editor">
  <template>
    <style>
       :host {
        display: block;
      }
    </style>

    <paper-input label="Name"
                 always-float-label
                 value="{{node.name}}"
                 on-change="__nameChanged"></paper-input>
    <div id="buttonbar">
      <paper-button raised
                    on-tap="_addTextContent">Add Text</paper-button>
      <paper-button raised
                    on-tap="_addJumpButton">Add Jump</paper-button>
    </div>

    <template is="dom-repeat"
              items="{{node.content}}">

      <iron-pages selected="[[item.type]]"
                  attr-for-selected="type">
        <paper-textarea type="text"
                        value="{{item.value}}"
                        label="Text"
                        always-float-label></paper-textarea>
        <div type="jump">
          <paper-input label="Button text"
                       always-float-label
                       value="{{item.text}}"></paper-input>
          <paper-dropdown-menu label="Target Node"
                               always-float-label>
            <!-- Use event to set selection so we can ensure it's the string, not the index -->
            <paper-listbox slot="dropdown-content"
                           selected="[[item.target]]" 
                           fallback-selection="0"
                           on-iron-select="__onJumpTargetSelect"
                           content="{{item}}">
              <template is="dom-repeat"
                        items="[[keys]]"
                        as="key">
                <paper-item key="[[key]]">[[__lookupNameOfNode(data,key)]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
      </iron-pages>

    </template>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class NodeEditor extends Polymer.Element {
      static get is() { return 'node-editor'; }
      static get properties() {
        return {
          // The complete game data.
          // This is provided so that we can look up the names of nodes.
          data: Object,
          // The keys to the 'data' object.
          // This is provided from outside for performance reasons, so there
          // is only ever one copy of the array.
          keys: Array,
          // The node being edited
          node: {
            type: Object,
            notify: true
          }
        };
      }

      _addTextContent() {
        this.push('node.content',
          {
            type: 'text',
            value: ''
          }
        );
      }

      _addJumpButton() {
        const firstNodeKey = Object.keys(this.data)[0];
        this.push('node.content',
          {
            type: 'jump',
            text: '',
            target: firstNodeKey
          })
      }

      __lookupNameOfNode(data, key) {
        return data[key].name;
      }

      __nameChanged(e) {
        this.notifyPath('node');
      }

      __onJumpTargetSelect(e) {
        const listbox = e.target;
        const item = e.target.selectedItem;
        listbox.content.target = item.key;
      }

    }

    window.customElements.define(NodeEditor.is, NodeEditor);
  </script>
</dom-module>