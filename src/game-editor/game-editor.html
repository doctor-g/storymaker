<link rel="import"
      href="../../bower_components/polymer/polymer-element.html">
<link rel="import"
      href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import"
      href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import"
      href="../../bower_components/paper-tabs/paper-tabs.html">

<link rel="import"
      href="../keyed-list/keyed-list.html">
<link rel="import"
      href="../node-editor/node-editor.html">
<link rel="import"
      href="../node-view/node-view.html">
<link rel="import"
      href="../variable-editor/variable-editor.html">
<link rel="import"
      href="../settings-editor/settings-editor.html">


<dom-module id="game-editor">
  <template>
    <style>
       :host {
        display: block;
      }

      .list {
        border-width: 1px;
        border-style: solid;
      }

      .buttons {
        display: flex;
      }

      .buttons > paper-icon-button {
        flex-grow: 0;
      }

      .buttons > .buttongap {
        flex-grow: 1;
      }
    </style>

    <div class="buttons">
      <paper-icon-button src="images/plus_n.png"
                         alt="Add Node"
                         on-tap="__addNode"></paper-icon-button>
      <paper-icon-button src="images/plus_v.png"
                         alt="Add Variable"
                         on-tap="__addVariable">+V</paper-icon-button>
      <paper-icon-button alt="Play Story"
                         on-tap="__play"
                         icon="play-arrow"
                         disabled="[[!__isStartNodeSpecified(game.startnode)]]">Play</paper-icon-button>
      <paper-icon-button icon="settings"
                         alt="Settings"
                         on-tap="__editSettings"></paper-icon-button>
      <div class="buttongap"></div>
      <paper-icon-button icon="close"
                         alt="close story"
                         on-tap="__close">Close</paper-icon-button>
    </div>

    <keyed-list id="nodelist"
                class="list"
                data="[[game.nodes]]"
                on-iron-select="__onNodeSelect">
    </keyed-list>
    <keyed-list id="variablelist"
                class="list"
                data="[[game.variables]]"
                on-iron-select="__onVariableSelect">
    </keyed-list>

    <iron-pages selected="[[__currentView]]"
                attr-for-selected="view">
      <div view="empty">
        Select or create a node
      </div>
      <settings-editor view="settingseditor"
                       id="settingseditor"
                       story="{{game}}"></settings-editor>
      <node-editor view="nodeeditor"
                   id="nodeeditor"
                   node="{{__selectedNode}}"
                   game="[[game]]"
                   on-delete-node="__deleteNode"></node-editor>
      <variable-editor view="variableeditor"
                       id="variableeditor"
                       variable="{{__selectedVariable}}"
                       on-delete-variable="__deleteVariable"></variable-editor>
    </iron-pages>

  </template>

  <script>
    class GameEditor extends Polymer.Element {
      static get is() { return 'game-editor'; }
      static get properties() {
        return {
          game: {
            type: Object,
            notify: true
          },

          __selectedNode: {
            type: Object,
            notify: true
          },

          __selectedVariable: {
            type: Object,
            notify: true
          },

          __editOrPreviewSelection: {
            type: Number,
            value: 0
          },

          __currentView: {
            type: String,
            value: 'empty'
          }
        };
      }

      __addNode() {
        const id = this.__getAndIncrement('nextNodeId');
        var key = 'node' + id;
        this.set('game.nodes.' + key,
          {
            name: 'Node ' + id,
            content: []
          }
        );
        this.$.nodelist.selectedKey = key;
      }

      __getAndIncrement(key) {
        const id = this.game[key];
        this.set('game.' + key, id + 1);
        return id;
      }

      __selectNodeByKey(key) {
        const node = this.game.nodes[key];
        this.unlinkPaths('__selectedNode');
        this.__selectedNode = node;
        this.linkPaths('__selectedNode', 'game.nodes.' + key);
        this.set('__currentView', 'nodeeditor');
        this.$.variablelist.selectedKey = null;
      }

      __onNodeSelect(event) {
        const key = event.detail.item.key;
        this.__selectNodeByKey(key);
      }

      __addVariable() {
        const id = this.__getAndIncrement('nextVariableId');
        var key = 'var' + id;
        this.set('game.variables.' + key,
          {
            name: 'Variable ' + id,
            default: '0'
          }
        );
        this.$.variablelist.selectedKey = key;
        this.notifyPath('game.variables');
      }

      __selectVariableByKey(key) {
        const variable = this.game.variables[key];
        this.unlinkPaths('__selectedVariable');
        this.__selectedVariable = variable;
        this.linkPaths('__selectedVariable', 'game.variables.' + key);
        this.set('__currentView', 'variableeditor');
        this.$.nodelist.selectedKey = null;
      }

      __onVariableSelect(event) {
        // Need to unselect node so that its editor refreshes on reopen rather than
        // seeing old version; this fixes the problem where variable name changes aren't seen.
        this.__selectedNode = null;

        // Now do the real work.
        const key = event.detail.item.key;
        this.__selectVariableByKey(key);
      }

      __play() {
        this.dispatchEvent(new CustomEvent('play'));
      }

      __isStartNodeSpecified(startnode) {
        return startnode;
      }

      __close() {
        this.dispatchEvent(new CustomEvent('close'));
      }

      __editSettings() {
        this.$.settingseditor.previousView = this.__currentView;
        this.__currentView = 'settingseditor';
      }

      __onSettingsClosed() {
        this.__currentView = this.$.settingseditor.previousView;
      }

      __deleteNode() {
        const key = this.$.nodelist.selectedKey;

        // Make sure we deselect the current node.
        this.$.nodelist.selectedKey = null;
        this.set('__currentView', 'empty');

        // If the deleted node was the starting node, unselect it.
        if (this.game.startnode === key) {
          this.set('game.startnode', null);
        }

        // Using 'delete' itself does not work in Polymer 2, so to get around this,
        // we make a copy with everything except the one we want to eliminate.
        var copy = JSON.parse(JSON.stringify(this.game.nodes));
        delete copy[key];
        this.set('game.nodes', copy);
      }

      __deleteVariable() {
        const key = this.$.variablelist.selectedKey;

        // Make sure we deselect the current variable.
        this.$.variablelist.selectedKey = null;
        this.set('__currentView', 'empty');

        // Using 'delete' itself does not work in Polymer 2, so to get around this,
        // we make a copy with everything except the one we want to eliminate.
        var copy = JSON.parse(JSON.stringify(this.game.variables));
        delete copy[key];
        this.set('game.variables', copy);
      }
    }

    window.customElements.define(GameEditor.is, GameEditor);
  </script>
</dom-module>