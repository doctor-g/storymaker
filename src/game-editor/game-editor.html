<link rel="import"
      href="../../bower_components/polymer/polymer-element.html">
<link rel="import"
      href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import"
      href="../../bower_components/paper-button/paper-button.html">
<link rel="import"
      href="../../bower_components/paper-tabs/paper-tabs.html">

<link rel="import"
      href="../keyed-list/keyed-list.html">
<link rel="import"
      href="../node-editor/node-editor.html">
<link rel="import"
      href="../node-view/node-view.html">
<link rel="import"
      href="../object-key-mapping/object-key-mapping.html">
<link rel="import"
      href="../variable-editor/variable-editor.html">




<dom-module id="game-editor">
  <template>
    <style>
       :host {
        display: block;
      }

      .list {
        border-width: 1px;
        border-style: solid;
      }
    </style>

    <object-key-mapping data="[[data]]"
                        keys="{{keys}}"></object-key-mapping>

    <paper-button raised
                  on-tap="__addNode">Add Node</paper-button>
    <paper-button raised
                  on-tap="__addVariable">Add Variable</paper-button>
    <paper-button raised
                  on-tap="__play"
                  disabled="[[__isNodeSetEmpty(data.*)]]">Play</paper-button>

    <keyed-list id="nodelist"
                class="list"
                data="[[data]]"
                on-iron-select="__onNodeSelect">
    </keyed-list>
    <keyed-list id="variablelist"
                class="list"
                data="[[variables]]"
                on-iron-select="__onVariableSelect">
    </keyed-list>

    <iron-pages selected="[[__currentView]]"
                attr-for-selected="view">
      <div view="empty">
        Empty game. Start adding stuff!
      </div>
      <div view="nodeeditor">
        <node-editor id="nodeeditor" node="{{__selectedNode}}" data="[[data]]" keys="[[keys]]" variables="[[variables]]"></node-editor>
      </div>
      <div view="variableeditor">
        <variable-editor id="variableeditor" variable="{{__selectedVariable}}"></variable-editor>
      </div>
    </iron-pages>

  </template>

  <script>
    /**
   * @customElement
   * @polymer
   */
    class GameEditor extends Polymer.Element {
      static get is() { return 'game-editor'; }
      static get properties() {
        return {
          data: {
            type: Object,
            notify: true,
          },

          keys: {
            type: Array,
            notify: true
          },

          variables: {
            type: Object,
            notify: true,
          },

          __selectedNode: {
            type: Object,
            notify: true
          },

          __selectedVariable: {
            type: Object,
            notify: true
          },

          __nextKey: {
            type: Number,
            value: 0
          },

          __editOrPreviewSelection: {
            type: Number,
            value: 0
          },

          __currentView: {
            type: String,
            value: 'empty'
          }
        };
      }

      __addNode() {
        const id = this.__nextKey++;
        var key = 'node' + id;
        this.set('data.' + key,
          {
            name: 'Node_' + id,
            content: []
          }
        );
        this.$.nodelist.selectedKey = key;
      }

      __selectNodeByKey(key) {
        const node = this.data[key];
        this.unlinkPaths('__selectedNode');
        this.__selectedNode = node;
        this.linkPaths('__selectedNode', 'data.' + key);
        this.set('__currentView', 'nodeeditor');
        this.$.variablelist.selectedKey = null;
      }

      __onNodeSelect(event) {
        const key = event.detail.item.key;
        this.__selectNodeByKey(key);
      }

      __addVariable() {
        const id = this.__nextKey++;
        var key = 'var' + id;
        this.set('variables.' + key,
          {
            name: 'Variable ' + id,
          }
        );
        this.$.variablelist.selectedKey = key;
      }

      __selectVariableByKey(key) {
        const variable = this.variables[key];
        this.unlinkPaths('__selectedVariable');
        this.__selectedVariable = variable;
        this.linkPaths('__selectedVariable', 'variables.' + key);
        this.set('__currentView', 'variableeditor');
        this.$.nodelist.selectedKey = null;
      }

      __onVariableSelect(event) {
        const key = event.detail.item.key;
        this.__selectVariableByKey(key);
      }

      __play() {
        this.dispatchEvent(new CustomEvent('play'));
      }

      __isNodeSetEmpty(dataChangeRecord) {
        return Object.keys(dataChangeRecord.base).length == 0;
      }
    }

    window.customElements.define(GameEditor.is, GameEditor);
  </script>
</dom-module>