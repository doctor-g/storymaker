<link rel="import"
      href="../../bower_components/polymer/polymer-element.html">
<link rel="import"
      href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import"
      href="../../bower_components/paper-button/paper-button.html">
<link rel="import"
      href="../../bower_components/paper-tabs/paper-tabs.html">

<link rel="import"
      href="../keyed-list/keyed-list.html">
<link rel="import"
      href="../node-editor/node-editor.html">
<link rel="import"
      href="../node-view/node-view.html">
<link rel="import"
      href="../variable-editor/variable-editor.html">

<dom-module id="game-editor">
  <template>
    <style>
       :host {
        display: block;
      }

      .list {
        border-width: 1px;
        border-style: solid;
      }
    </style>

    <paper-button raised
                  on-tap="__addNode">Add Node</paper-button>
    <paper-button raised
                  on-tap="__addVariable">Add Variable</paper-button>
    <paper-button raised
                  on-tap="__play"
                  disabled="[[__isNodeSetEmpty(data.*)]]">Play</paper-button>

    <keyed-list id="nodelist"
                class="list"
                data="[[game.nodes]]"
                on-iron-select="__onNodeSelect">
    </keyed-list>
    <keyed-list id="variablelist"
                class="list"
                data="[[game.variables]]"
                on-iron-select="__onVariableSelect">
    </keyed-list>

    <iron-pages selected="[[__currentView]]"
                attr-for-selected="view">
      <div view="empty">
        Empty game. Start adding stuff!
      </div>
      <div view="nodeeditor">
        <node-editor id="nodeeditor"
                     node="{{__selectedNode}}"
                     game="[[game]]"></node-editor>
      </div>
      <div view="variableeditor">
        <variable-editor id="variableeditor"
                         variable="{{__selectedVariable}}"></variable-editor>
      </div>
    </iron-pages>

  </template>

  <script>
    class GameEditor extends Polymer.Element {
      static get is() { return 'game-editor'; }
      static get properties() {
        return {
          game: {
            type: Object,
            notify: true
          },

          __selectedNode: {
            type: Object,
            notify: true
          },

          __selectedVariable: {
            type: Object,
            notify: true
          },

          __nextNodeKey: {
            type: Number,
            value: 0
          },

          __nextVariableKey: {
            type: Number,
            value: 0
          },

          __editOrPreviewSelection: {
            type: Number,
            value: 0
          },

          __currentView: {
            type: String,
            value: 'empty'
          }
        };
      }

      __addNode() {
        const id = this.__nextNodeKey++;
        var key = 'node' + id;
        this.set('game.nodes.' + key,
          {
            name: 'Node_' + id,
            content: []
          }
        );
        this.$.nodelist.selectedKey = key;
      }

      __selectNodeByKey(key) {
        const node = this.game.nodes[key];
        this.unlinkPaths('__selectedNode');
        this.__selectedNode = node;
        this.linkPaths('__selectedNode', 'game.nodes.' + key);
        this.set('__currentView', 'nodeeditor');
        this.$.variablelist.selectedKey = null;
      }

      __onNodeSelect(event) {
        const key = event.detail.item.key;
        this.__selectNodeByKey(key);
      }

      __addVariable() {
        const id = this.__nextVariableKey++;
        var key = 'var' + id;
        this.set('game.variables.' + key,
          {
            name: 'Variable ' + id,
          }
        );
        this.$.variablelist.selectedKey = key;
        this.notifyPath('game.variables'); 
      }

      __selectVariableByKey(key) {
        const variable = this.game.variables[key];
        this.unlinkPaths('__selectedVariable');
        this.__selectedVariable = variable;
        this.linkPaths('__selectedVariable', 'game.variables.' + key);
        this.set('__currentView', 'variableeditor');
        this.$.nodelist.selectedKey = null;
      }

      __onVariableSelect(event) {
        const key = event.detail.item.key;
        this.__selectVariableByKey(key);
      }

      __play() {
        this.dispatchEvent(new CustomEvent('play'));
      }

      __isNodeSetEmpty(dataChangeRecord) {
        return Object.keys(dataChangeRecord.base).length == 0;
      }
    }

    window.customElements.define(GameEditor.is, GameEditor);
  </script>
</dom-module>